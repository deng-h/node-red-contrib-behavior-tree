<script type="text/html" data-template-name="bt-parallel">
    <!-- 节点配置表单 -->
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> 名称</label>
        <input type="text" id="node-input-name" placeholder="并行节点">
    </div>
    
    <div class="form-row">
        <label>子节点管理</label>
        <button class="btn btn-xs" id="add-child"><i class="fa fa-plus"></i> 添加子节点</button>
        <button class="btn btn-xs" id="remove-child"><i class="fa fa-minus"></i> 移除子节点</button>
        <span class="form-tip" style="margin-left:10px;">当前: <span id="child-count">1</span> 个</span>
    </div>

    <div class="form-row">
        <label for="node-input-completionType"><i class="fa fa-check-square-o"></i> 完成条件</label>
        <select id="node-input-completionType">
            <option value="all_success">所有子节点成功</option>
            <option value="any_success">任一子节点成功</option>
            <option value="all_complete">所有子节点完成</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-globalKey"><i class="fa fa-globe"></i> 全局状态键名</label>
        <input type="text" id="node-input-globalKey" value="parallel_status" placeholder="全局变量键名">
    </div>
    <div class="form-row">
        <label for="node-input-childKey"><i class="fa fa-globe"></i> 子状态键名</label>
        <input type="text" id="node-input-childKey" value="child_result" placeholder="子状态键名">
    </div>
</script>

<script type="text/html" data-help-name="bt-parallel">
    <p>行为树并行节点（parallel_node）：同时执行多个子节点，根据配置的完成条件判断整体结果。</p>
    <h3>配置项</h3>
    <ul>
        <li><strong>子节点数量</strong>：并行执行的子节点个数（输出端口数量）</li>
        <li><strong>完成条件</strong>：
            <ul>
                <li>子节点状态包含：success，failure</li>
                <li>所有子节点成功：全部子节点返回 success 才成功</li>
                <li>任一子节点成功：有一个子节点返回 success 即成功</li>
                <li>所有子节点完成：等待所有子节点结束，有成功则整体成功</li>
            </ul>
        </li>
        <li><strong>全局状态键名</strong>：用于存储子节点状态的全局变量键名</li>
    </ul>

    <h3>消息格式要求</h3>
    <p><strong>子节点输入</strong>：任意格式消息</p>
    <p><strong>子节点输出</strong>：必须包含状态字段
        <pre>global.{$全局状态键名} = {
            type: "parallel",
            status: "success",  父节点状态，无需配置
            child_status: ["success"] 子节点状态，第几个子节点就配置第几个参数状态
        }</pre>
    </p>
</script>

<script type="text/javascript">
    // 注册节点外观定义
    RED.nodes.registerType('bt-parallel', {
        category: 'behaviors', // 节点分类（功能区）
        color: '#ffa500',     // 节点背景色
        defaults: {
            name: { value: "" },
            outputs: { value: 1 },
            completionType: { value: "all_success" },
            globalKey: { value: "parallel_result" },
            childKey: { value: "child_result" }        // 全局状态键名
        },
        inputs: 1,              // 输入端口数
        outputs: 1,             // 输出端口数（动态）
        icon: "parallel.svg", // 节点图标（可自定义）
        label: function() {
            return this.name || "parallel"; // 节点显示名称
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        paletteLabel: "parallel",
        
        oneditprepare: function() {
            const node = this;
            
            // 显示当前子节点数量
            function updateChildCount() {
                $('#child-count').text(node.outputs);
            }
            
            // 添加子节点端口
            $('#add-child').click(function() {
                node.outputs++;
                updateChildCount();
                RED.nodes.eachNode(n => {
                    if (n.id === node.id) n.outputs = node.outputs;
                });
                $(node).trigger('change');
            });
            
            // 移除子节点端口（至少保留1个）
            $('#remove-child').click(function() {
                if (node.outputs > 1) {
                    node.outputs--;
                    updateChildCount();
                    RED.nodes.eachNode(n => {
                        if (n.id === node.id) n.outputs = node.outputs;
                    });
                    $(node).trigger('change');
                }
            });
            
            // 初始化显示
            updateChildCount();
        }
    });
</script>
