<!-- 节点配置表单 -->
<script type="text/html" data-template-name="bt-repeat">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> 名称</label>
        <input type="text" id="node-input-name" placeholder="重复节点">
    </div>
    <div class="form-row">
        <label for="node-input-repeatCount"><i class="fa fa-repeat"></i> 重复次数</label>
        <input type="number" id="node-input-repeatCount" min="1" value="3" placeholder="默认3次">
    </div>
    <div class="form-row">
        <label for="node-input-globalRepeatCount"><i class="fa fa-globe"></i> 重复次数参数</label>
        <input type="text" id="node-input-globalRepeatCount" value="repeat_count" placeholder="从全局变量获取次数">
    </div>
    <!-- 修改：将复选框改为下拉菜单 -->
    <div class="form-row">
        <label for="node-input-terminationCondition"><i class="fa fa-signal"></i> 终止条件</label>
        <select id="node-input-terminationCondition">
            <option value="fixed">固定次数</option>
            <option value="untilSuccess">直到成功</option>
            <option value="exitOnFailure">失败即退出</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-globalKey"><i class="fa fa-globe"></i> 全局状态键名</label>
        <input type="text" id="node-input-globalKey" value="repeat_result" placeholder="全局变量键名">
    </div>
    <div class="form-row">
        <label for="node-input-childKey"><i class="fa fa-child"></i> 子状态键名</label>
        <input type="text" id="node-input-childKey" value="child_result" placeholder="子节点状态键名">
    </div>
</script>

<!-- 帮助信息 -->
<script type="text/html" data-help-name="bt-repeat">
    <p>行为树重复节点（bt-repeat）：按配置重复执行子节点。</p>
    <h3>核心功能</h3>
    <ul>
        <li>重复执行单个子节点，每次执行完成后检查结果</li>
        <li>支持三种终止条件：固定次数、直到成功、失败即退出</li>
        <li>可通过全局参数动态配置重复次数</li>
    </ul>
    <h3>配置项说明</h3>
    <ul>
        <li><strong>重复次数</strong>：默认执行的次数（至少1次）</li>
        <li><strong>重复次数参数</strong>：从全局变量获取次数，优先级高于固定配置</li>
        <li><strong>终止条件</strong>：
            <ul>
                <li><strong>固定次数</strong>：执行指定次数后停止</li>
                <li><strong>直到成功</strong>：直到子节点返回成功才停止</li>
                <li><strong>失败即退出</strong>：一旦子节点失败，立即停止</li>
            </ul>
        </li>
        <li><strong>全局状态键名</strong>：用于父节点与子节点通信的全局变量</li>
    </ul>
    <h3>子节点交互</h3>
    <p>子节点完成后，必须更新全局状态：
        <pre>
// 成功时
global.set('repeat_result', {
    ...global.get('repeat_result'),
    child_status: "success" 
});

// 失败时
global.set('repeat_result', {
    ...global.get('repeat_result'),
    child_status: "failure" 
});
        </pre>
    </p>
</script>

<!-- 节点注册 -->
<script type="text/javascript">
    RED.nodes.registerType('bt-repeat', {
        category: 'behaviors',
        color: '#f0e68c',
        defaults: {
            name: { value: "" },
            repeatCount: { value: 3, validate: v => v >= 1 },
            globalRepeatCount: { value: "repeat_count" },
            terminationCondition: { value: "fixed" }, // 新增
            globalKey: { value: "repeat_result" },
            childKey: { value: "child_result" }
        },
        inputs: 1,
        outputs: 1,
        icon: "loop.svg",
        label: function() {
            return this.name || `repeat`;
        },
        paletteLabel: "repeat"
    });
</script>
